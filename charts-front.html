<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Charts</title>
</head>
<body>
<!-- Styles -->
<style>
    #chartdiv {
        width: 100%;
        height: 500px;
        max-width: 100%;
    }

</style>

<!-- Resources -->
<script src="https://cdn.amcharts.com/lib/4/core.js"></script>
<script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
<script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

<!-- Chart code -->
<script>

    let chartData = [];

    function getData() {
        fetch('http://localhost:3000/chart-data', {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then(response => response.json())
            .then(data => {
                chartData = [...chartData, data]
                console.log(chartData)
            })
    }

    setInterval(() => {
        getData();
    }, 3000)

    setInterval(() => {
        am4core.ready(function () {

// Themes begin
            am4core.useTheme(am4themes_animated);
// Themes end


// Create chart instance
            var chart = am4core.create("chartdiv", am4charts.XYChart);

// Create axes
            var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
            var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

            const properties = Object.keys(chartData[0]);
            for (let j = 0; j < properties.length; j++) {
                createSeries(j, properties[j]);
            }

// Create series
            function createSeries(s, name) {
                var series = chart.series.push(new am4charts.LineSeries());
                series.dataFields.valueY = "value" + s;
                series.dataFields.dateX = "date";
                series.name = name;

                var segment = series.segments.template;
                segment.interactionsEnabled = true;

                var hoverState = segment.states.create("hover");
                hoverState.properties.strokeWidth = 3;

                var dimmed = segment.states.create("dimmed");
                dimmed.properties.stroke = am4core.color("#dadada");

                segment.events.on("over", function (event) {
                    processOver(event.target.parent.parent.parent);
                });

                segment.events.on("out", function (event) {
                    processOut(event.target.parent.parent.parent);
                });

                let data = [];
                let value = 0;
                for (let i = 0; i < chartData.length; i++) {
                    value = chartData[i][name];
                    let dataItem = {date: new Date(2020, 0, 1, 0, 0, i)};
                    dataItem["value" + s] = value;
                    data.push(dataItem);
                }


                series.data = data;
                return series;
            }

            chart.legend = new am4charts.Legend();
            chart.legend.position = "right";
            chart.legend.scrollable = true;
            chart.legend.itemContainers.template.events.on("over", function (event) {
                processOver(event.target.dataItem.dataContext);
            })

            chart.legend.itemContainers.template.events.on("out", function (event) {
                processOut(event.target.dataItem.dataContext);
            })

            function processOver(hoveredSeries) {
                hoveredSeries.toFront();

                hoveredSeries.segments.each(function (segment) {
                    segment.setState("hover");
                })

                chart.series.each(function (series) {
                    if (series != hoveredSeries) {
                        series.segments.each(function (segment) {
                            segment.setState("dimmed");
                        })
                        series.bulletsContainer.setState("dimmed");
                    }
                });
            }

            function processOut(hoveredSeries) {
                chart.series.each(function (series) {
                    series.segments.each(function (segment) {
                        segment.setState("default");
                    })
                    series.bulletsContainer.setState("default");
                });
            }

        }); // end am4core.ready()
    }, 5000) //end setInterval
</script>

<!-- HTML -->
<div id="chartdiv"></div>

</body>
</html>
